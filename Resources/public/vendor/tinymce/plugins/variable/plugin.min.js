/**
 * plugin.js
 *
 * Copyright, BuboBox
 * Released under MIT License.
 *
 * License: https://www.bubobox.com
 * Contributing: https://www.bubobox.com/contributing
 */
/*global tinymce:true */
tinymce.PluginManager.add("variable",function(e){tinymce.util.VK;var a=e.getParam("variable_mapper",{}),t=e.getParam("variable_valid",null),n=e.getParam("variable_tag","span")||"span",r=e.getParam("variable_class","variable"),i=e.getParam("variable_prefix","{{"),l=e.getParam("variable_suffix","}}"),o=new RegExp(i+"[ s\t]*([a-z. _]*)?[ s\t]*"+l,"gi");function u(e){return e.replace(/[^a-zA-Z0-9._]/g,"")}function c(o){var c,d=u(o);if(c=d,t&&0!==t.length&&!(("|"+t.join("|")+"|").indexOf("|"+c+"|")>-1))return o;var f=function(e){return"function"==typeof a?a(e):a.hasOwnProperty(e)?a[e]:e}(d);return e.fire("variableToHTML",{value:o,cleanValue:d}),"<"+n+' class="'+r+'" data-original-variable="'+(i+d+l)+'" contenteditable="false">'+f+"</"+n+">"}function d(){var a,t,n,r=[];tinymce.walk(e.getBody(),function(e){3==e.nodeType&&e.nodeValue&&o.test(e.nodeValue)&&r.push(e)},"childNodes");for(var i=0;i<r.length;i++){for(a=r[i].nodeValue.replace(o,c),n=e.dom.create("div",null,a);t=n.lastChild;)if(e.dom.insertAfter(t,r[i]),f(t)){var l=t.nextSibling;e.selection.setCursorLocation(l)}e.dom.remove(r[i])}}function f(e){return!("function"!=typeof e.getAttribute||!e.hasAttribute("data-original-variable"))}e.on("nodechange",d),e.on("keyup",d),e.on("beforegetcontent",function(a){return"raw"===a.format?d():function(){var a,t,n,r=[];tinymce.walk(e.getBody(),function(e){1==e.nodeType&&null!==e.getAttribute("data-original-variable")&&r.push(e)},"childNodes");for(var i=0;i<r.length;i++){for(a=r[i].getAttribute("data-original-variable"),n=e.dom.create("div",null,a);t=n.lastChild;)e.dom.insertAfter(t,r[i]);e.dom.remove(r[i])}}()}),e.on("click",function(a){var t=a.target;if(!f(t))return null;var n=t.getAttribute("data-original-variable");e.fire("variableClick",{value:u(n),target:t})}),this.addVariable=function(a){var t=c(a);e.execCommand("mceInsertContent",!1,t)}});

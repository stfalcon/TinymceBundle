/**
 * plugin.js
 *
 * Copyright, BuboBox
 * Released under MIT License.
 *
 * License: https://www.bubobox.com
 * Contributing: https://www.bubobox.com/contributing
 */

/*global tinymce:true */

tinymce.PluginManager.add("variable",function(e){tinymce.util.VK;var a=e.getParam("variable_mapper",{}),t=e.getParam("variable_valid",null),n=e.getParam("variable_class","variable"),r=e.getParam("variable_prefix","{{"),i=e.getParam("variable_suffix","}}"),l=new RegExp(r+"[ s\t]*([a-z. _]*)?[ s\t]*"+i,"gi");function o(e){return e.replace(/[^a-zA-Z0-9._]/g,"")}function u(l){var u,c=o(l);if(u=c,t&&0!==t.length&&!(("|"+t.join("|")+"|").indexOf("|"+u+"|")>-1))return l;var d=function(e){return"function"==typeof a?a(e):a.hasOwnProperty(e)?a[e]:e}(c);return e.fire("variableToHTML",{value:l,cleanValue:c}),'<b class="'+n+'" data-original-variable="'+(r+c+i)+'" contenteditable="false">'+d+"</b>"}function c(){var a,t,n,r=[];tinymce.walk(e.getBody(),function(e){3==e.nodeType&&e.nodeValue&&l.test(e.nodeValue)&&r.push(e)},"childNodes");for(var i=0;i<r.length;i++){for(a=r[i].nodeValue.replace(l,u),n=e.dom.create("div",null,a);t=n.lastChild;)if(e.dom.insertAfter(t,r[i]),d(t)){var o=t.nextSibling;e.selection.setCursorLocation(o)}e.dom.remove(r[i])}}function d(e){return!("function"!=typeof e.getAttribute||!e.hasAttribute("data-original-variable"))}e.on("nodechange",c),e.on("keyup",c),e.on("beforegetcontent",function(a){return"raw"===a.format?c():function(){var a,t,n,r=[];tinymce.walk(e.getBody(),function(e){1==e.nodeType&&null!==e.getAttribute("data-original-variable")&&r.push(e)},"childNodes");for(var i=0;i<r.length;i++){for(a=r[i].getAttribute("data-original-variable"),n=e.dom.create("div",null,a);t=n.lastChild;)e.dom.insertAfter(t,r[i]);e.dom.remove(r[i])}}()}),e.on("click",function(a){var t=a.target;if(!d(t))return null;var n=t.getAttribute("data-original-variable");e.fire("variableClick",{value:o(n),target:t})}),this.addVariable=function(a){var t=u(a);e.execCommand("mceInsertContent",!1,t)}});
